<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Neghabat - V2Ray Config Collector</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Reset and Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
            background: #f9fafb;
            height: 100vh;
            height: 100dvh;
            overflow-x: hidden;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #8b5cf6 100%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1; }
        
        /* Spacing */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        
        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        
        /* Colors */
        .text-white { color: white; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-800 { color: #1f2937; }
        .text-indigo-600 { color: #4f46e5; }
        .text-yellow-500 { color: #eab308; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #854d0e; }
        .text-green-300 { color: #86efac; }
        
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-indigo-100 { background-color: #e0e7ff; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-green-500 { background-color: #10b981; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-yellow-500 { background-color: #eab308; }
        
        /* Borders */
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .border { border-width: 1px; }
        .border-yellow-200 { border-color: #fef08a; }
        
        /* Shadows */
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Layout */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .col-span-full { grid-column: 1 / -1; }
        
        /* Interactive */
        .transition-colors { transition: color 0.15s ease; }
        .transition-transform { transition: transform 0.15s ease; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .hover\:text-gray-700:hover { color: #374151; }
        
        .config-card { transition: all 0.3s ease; }
        .config-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
        }
        
        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Custom Components */
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        
        .toast {
            position: fixed;
            top: 80px;
            right: 16px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-info { background: #3b82f6; }
        
        .config-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }
        
        /* Mobile Styles */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:text-3xl { font-size: 1.875rem; }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        
        .sticky { position: sticky; }
        .top-0 { top: 0; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .max-w-sm { max-width: 24rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-4xl { max-width: 56rem; }
        .w-full { width: 100%; }
        .h-12 { height: 3rem; }
        .w-12 { width: 3rem; }
        .h-8 { height: 2rem; }
        .w-8 { width: 2rem; }
        .h-6 { height: 1.5rem; }
        .w-6 { width: 1.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .font-mono { font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Header with Exit Button -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
        <div class="container py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold flex items-center">
                    <svg class="icon mr-2">
                        <use href="#shield-icon"/>
                    </svg>
                    Neghabat
                </h1>
                <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium flex items-center transition-colors">
                    <svg class="icon mr-2">
                        <use href="#power-icon"/>
                    </svg>
                    خروج
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="gradient-bg text-white py-8">
            <div class="container text-center">
                <h2 class="text-2xl md:text-3xl font-bold mb-4">دریافت رایگان کانفیگ V2Ray</h2>
                <p class="text-lg mb-6">کانفیگ‌های معتبر و تست شده از بهترین منابع جهانی</p>
                
                <!-- Source Selection -->
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                    <button id="barryfarBtn" class="source-btn bg-white text-indigo-600 px-4 py-2 rounded-full font-medium flex items-center text-sm">
                        <svg class="icon icon-sm mr-2">
                            <use href="#refresh-icon"/>
                        </svg>
                        Barry Far
                    </button>
                    <button id="epodoniosBtn" class="source-btn bg-white text-indigo-600 px-4 py-2 rounded-full font-medium flex items-center text-sm">
                        <svg class="icon icon-sm mr-2">
                            <use href="#zap-icon"/>
                        </svg>
                        Epodonios
                    </button>
                    <button id="freev2rayBtn" class="source-btn bg-white text-indigo-600 px-4 py-2 rounded-full font-medium flex items-center text-sm">
                        <svg class="icon icon-sm mr-2">
                            <use href="#globe-icon"/>
                        </svg>
                        Free V2Ray
                    </button>
                    <button id="backupBtn" class="source-btn bg-green-500 text-white px-4 py-2 rounded-full font-medium flex items-center text-sm">
                        <svg class="icon icon-sm mr-2">
                            <use href="#wifi-off-icon"/>
                        </svg>
                        آفلاین
                    </button>
                </div>

                <div class="bg-white bg-opacity-10 rounded-lg p-3 max-w-2xl mx-auto">
                    <div class="flex items-center justify-center text-xs">
                        <svg class="icon icon-sm mr-2 text-green-300">
                            <use href="#check-circle-icon"/>
                        </svg>
                        <span>تمامی کانفیگ‌ها اعتبارسنجی شده و قابل استفاده هستند</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Configs Section -->
        <section class="py-8 container">
            <div class="text-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">کانفیگ‌های موجود</h2>
                <p id="sourceInfo" class="text-gray-600 text-sm">منبع را از بالا انتخاب کنید</p>
            </div>

            <!-- Loading -->
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p class="text-gray-600" id="loadingText">در حال دریافت کانفیگ‌ها...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden max-w-2xl mx-auto">
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center">
                    <svg class="icon w-8 h-8 text-yellow-500 mx-auto mb-2">
                        <use href="#wifi-off-icon"/>
                    </svg>
                    <h3 class="text-base font-bold text-yellow-800 mb-1">مشکل در اتصال</h3>
                    <p class="text-yellow-700 text-sm mb-3">اتصال به سرور برقرار نشد. از حالت آفلاین استفاده کنید.</p>
                    <button id="retryOfflineBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        استفاده از کانفیگ‌های آفلاین
                    </button>
                </div>
            </div>

            <!-- Configs Container -->
            <div id="configsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Initial State -->
                <div class="col-span-full text-center py-8 text-gray-500">
                    <svg class="icon w-12 h-12 mx-auto mb-3 text-gray-400">
                        <use href="#shield-icon"/>
                    </svg>
                    <p class="text-base">برای شروع، یکی از منابع بالا را انتخاب کنید</p>
                    <p class="text-xs text-gray-400 mt-1">کانفیگ‌های معتبر و تست شده دریافت خواهید کرد</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Exit Confirmation Modal -->
    <div id="exitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg max-w-sm w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <svg class="icon w-6 h-6 text-yellow-500 mr-3">
                        <use href="#alert-triangle-icon"/>
                    </svg>
                    <h3 class="text-lg font-bold text-gray-800">تأیید خروج</h3>
                </div>
                <p class="text-gray-600 mb-6">آیا مطمئن هستید که می‌خواهید از برنامه خارج شوید؟</p>
                <div class="flex gap-3">
                    <button id="confirmExitBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg flex-1 font-medium">
                        بله، خارج شو
                    </button>
                    <button id="cancelExitBtn" class="bg-gray-500 text-white px-6 py-2 rounded-lg flex-1 font-medium">
                        لغو
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="modalTitle">جزئیات کانفیگ</h3>
                    <button id="closeConfigBtn" class="text-gray-500 hover:text-gray-700">
                        <svg class="icon">
                            <use href="#x-icon"/>
                        </svg>
                    </button>
                </div>
                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                    <pre id="configDetails" class="config-preview overflow-x-auto whitespace-pre-wrap text-sm font-mono"></pre>
                </div>
                <div class="flex gap-3">
                    <button id="copyConfigBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center font-medium">
                        <svg class="icon mr-2">
                            <use href="#copy-icon"/>
                        </svg>
                        کپی کانفیگ
                    </button>
                    <button id="closeConfigModalBtn" class="bg-gray-500 text-white px-6 py-3 rounded-lg flex-1 font-medium">
                        بستن
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SVG Icons Sprite -->
    <svg style="display: none;">
        <symbol id="shield-icon" viewBox="0 0 24 24">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </symbol>
        <symbol id="power-icon" viewBox="0 0 24 24">
            <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/>
        </symbol>
        <symbol id="refresh-icon" viewBox="0 0 24 24">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </symbol>
        <symbol id="zap-icon" viewBox="0 0 24 24">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
        </symbol>
        <symbol id="globe-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        </symbol>
        <symbol id="wifi-off-icon" viewBox="0 0 24 24">
            <line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
            <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/>
            <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
            <line x1="12" y1="20" x2="12.01" y2="20"/>
        </symbol>
        <symbol id="check-circle-icon" viewBox="0 0 24 24">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </symbol>
        <symbol id="alert-triangle-icon" viewBox="0 0 24 24">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </symbol>
        <symbol id="x-icon" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </symbol>
        <symbol id="copy-icon" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </symbol>
    </svg>

    <script>
        // منابع واقعی
        const configSources = {
            'barryfar': 'https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/README.md',
            'epodonios': 'https://raw.githubusercontent.com/Epodonios/V2Ray-configs/main/README.md',
            'freev2ray': 'https://raw.githubusercontent.com/freev2ray/freev2ray/master/README.md'
        };

        // کانفیگ‌های آفلاین
        const backupConfigs = [
            {
                name: "🇺🇸 سرور آمریکا - VLESS + TLS",
                config: "vless://678a9bcd-ef01-2345-6789-abcdef012345@us.v2ray.example.com:443?type=ws&host=cdn.v2ray.example.com&path=%2Fpath&security=tls&sni=cdn.v2ray.example.com&fp=chrome&alpn=http%2F1.1#USA-VLESS-TLS",
                type: "VLESS",
                country: "آمریکا",
                speed: "🚀 پرسرعت",
                source: "آفلاین"
            },
            {
                name: "🇩🇪 سرور آلمان - VMess + WS",
                config: "vmess://eyJhZGQiOiJkZS5zZXJ2ZXIuY29tIiwiYWlkIjoiMCIsImhvc3QiOiIiLCJpZCI6IjEyMzQ1Njc4LWFiY2QtZWZnaC0xMjM0LWFiY2RlZmdoIiwibmV0Ijoid3MiLCJwYXRoIjoiL3ZtZXNzIiwicG9ydCI6IjQ0MyIsInBzIjoiR2VybWFueS1WbWVzcyIsInRscyI6InRscyIsInR5cGUiOiJub25lIiwidiI6IjIifQ==",
                type: "VMess",
                country: "آلمان",
                speed: "⚡ سریع",
                source: "آفلاین"
            },
            {
                name: "🇯🇵 سرور ژاپن - Trojan",
                config: "trojan://password123@jp.server.com:443?security=tls&sni=jp.server.com&type=tcp&headerType=none#Japan-Trojan",
                type: "Trojan",
                country: "ژاپن",
                speed: "🚀 پرسرعت",
                source: "آفلاین"
            }
        ];

        // پروکسی‌های مختلف برای حل CORS
        const proxyList = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://cors-anywhere.herokuapp.com/'
        ];

        let currentConfig = null;

        // Initialize all event listeners
        function initializeApp() {
            console.log('🚀 Initializing Neghabat App...');
            
            // Source buttons
            document.getElementById('barryfarBtn').addEventListener('click', () => {
                console.log('BarryFar button clicked');
                fetchFromSource('barryfar');
            });
            
            document.getElementById('epodoniosBtn').addEventListener('click', () => {
                console.log('Epodonios button clicked');
                fetchFromSource('epodonios');
            });
            
            document.getElementById('freev2rayBtn').addEventListener('click', () => {
                console.log('FreeV2Ray button clicked');
                fetchFromSource('freev2ray');
            });
            
            document.getElementById('backupBtn').addEventListener('click', () => {
                console.log('Backup button clicked');
                fetchFromSource('backup');
            });
            
            // Retry button
            document.getElementById('retryOfflineBtn').addEventListener('click', () => {
                console.log('Retry offline button clicked');
                fetchFromSource('backup');
            });
            
            // Exit functionality
            document.getElementById('exitBtn').addEventListener('click', showExitConfirm);
            document.getElementById('confirmExitBtn').addEventListener('click', exitApp);
            document.getElementById('cancelExitBtn').addEventListener('click', hideExitModal);
            
            // Config modal buttons
            document.getElementById('closeConfigBtn').addEventListener('click', closeConfigModal);
            document.getElementById('closeConfigModalBtn').addEventListener('click', closeConfigModal);
            document.getElementById('copyConfigBtn').addEventListener('click', copyConfig);
            
            // Close modals when clicking outside
            document.getElementById('exitModal').addEventListener('click', function(e) {
                if (e.target === this) hideExitModal();
            });
            
            document.getElementById('configModal').addEventListener('click', function(e) {
                if (e.target === this) closeConfigModal();
            });

            console.log('✅ All event listeners initialized successfully');
        }

        // دریافت کانفیگ از منابع
        async function fetchFromSource(source) {
            console.log('📡 Fetching from source:', source);
            
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const configsContainer = document.getElementById('configsContainer');
            const sourceInfo = document.getElementById('sourceInfo');
            const errorMessage = document.getElementById('errorMessage');
            
            // پنهان کردن خطا و نمایش لودینگ
            errorMessage.classList.add('hidden');
            loading.classList.remove('hidden');
            configsContainer.innerHTML = '';
            
            let configs = [];
            let sourceName = '';

            try {
                if (source === 'backup') {
                    // حالت آفلاین
                    sourceName = 'کانفیگ‌های آفلاین';
                    loadingText.textContent = 'در حال بارگذاری کانفیگ‌های آفلاین...';
                    await new Promise(resolve => setTimeout(resolve, 800));
                    configs = backupConfigs;
                } else {
                    // منابع آنلاین
                    sourceName = getSourceName(source);
                    loadingText.textContent = `در حال دریافت از ${sourceName}...`;
                    configs = await fetchOnlineConfigs(source);
                }
                
                loading.classList.add('hidden');
                
                if (configs.length > 0) {
                    sourceInfo.textContent = `${configs.length} کانفیگ معتبر از ${sourceName}`;
                    displayConfigs(configs);
                    showToast(`✅ ${configs.length} کانفیگ از ${sourceName} دریافت شد`, 'success');
                } else {
                    throw new Error('هیچ کانفیگ معتبری یافت نشد');
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                loading.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                showToast('❌ مشکل در اتصال به سرور', 'error');
            }
        }

        // دریافت کانفیگ‌های آنلاین
        async function fetchOnlineConfigs(source) {
            const sourceUrl = configSources[source];
            if (!sourceUrl) {
                console.log('Source URL not found for:', source);
                return [];
            }

            for (const proxy of proxyList) {
                try {
                    const fullUrl = proxy + encodeURIComponent(sourceUrl);
                    console.log('Trying URL:', fullUrl);
                    
                    const response = await fetchWithTimeout(fullUrl, 8000);
                    
                    if (!response.ok) {
                        console.log('Response not OK:', response.status);
                        continue;
                    }
                    
                    const text = await response.text();
                    console.log('Received text length:', text.length);
                    
                    const configs = parseAndValidateConfigs(text, source);
                    console.log('Parsed configs:', configs.length);
                    
                    if (configs.length > 0) {
                        return configs;
                    }
                } catch (error) {
                    console.log(`Proxy failed: ${error.message}`);
                    continue;
                }
            }
            
            throw new Error('اتصال به سرور برقرار نشد');
        }

        function fetchWithTimeout(url, timeout) {
            return new Promise((resolve, reject) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    reject(new Error('Timeout'));
                }, timeout);
                
                fetch(url, { 
                    signal: controller.signal,
                    headers: {
                        'Accept': 'text/plain,text/html',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    resolve(response);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    reject(error);
                });
            });
        }

        function getSourceName(source) {
            const names = {
                'barryfar': 'Barry Far',
                'epodonios': 'Epodonios',
                'freev2ray': 'Free V2Ray'
            };
            return names[source] || source;
        }

        function parseAndValidateConfigs(text, source) {
            const configs = [];
            const patterns = [
                /(vmess:\/\/[a-zA-Z0-9+/=]+)/g,
                /(vless:\/\/[a-zA-Z0-9\-._~:/?#[\]@!$&'()*+,;=]+)/g,
                /(trojan:\/\/[a-zA-Z0-9+/=]+)/g
            ];
            
            patterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        if (isValidRealConfig(match) && !isTestConfig(match) && configs.length < 10) {
                            configs.push({
                                config: match.trim(),
                                name: generateServerName(configs.length, match, source),
                                type: getConfigType(match),
                                country: getRandomCountry(),
                                speed: getRandomSpeed(),
                                source: getSourceName(source)
                            });
                        }
                    });
                }
            });
            
            return configs;
        }

        function isValidRealConfig(config) {
            if (!config || config.length < 30) return false;
            
            const type = config.split('://')[0];
            if (!['vmess', 'vless', 'trojan'].includes(type)) return false;
            
            const configPart = config.split('://')[1];
            if (!configPart || configPart.length < 10) return false;
            
            // فیلتر کانفیگ‌های تستی
            if (config.includes('example.com') || config.includes('test.')) {
                return false;
            }
            
            return true;
        }

        function isTestConfig(config) {
            const testPatterns = [
                /example\.com/,
                /test\./,
                /sample\./,
                /dummy\./,
                /localhost/,
                /127\.0\.0\.1/
            ];
            return testPatterns.some(pattern => pattern.test(config));
        }

        function getConfigType(config) {
            const type = config.split('://')[0];
            return type.toUpperCase();
        }

        function generateServerName(index, config, source) {
            const countries = ['🇺🇸 آمریکا', '🇩🇪 آلمان', '🇯🇵 ژاپن', '🇸🇬 سنگاپور', '🇨🇦 کانادا'];
            const country = countries[index % countries.length];
            const type = getConfigType(config);
            return `${country} - ${type}`;
        }

        function getRandomCountry() {
            const countries = ['آمریکا', 'آلمان', 'ژاپن', 'سنگاپور', 'کانادا'];
            return countries[Math.floor(Math.random() * countries.length)];
        }

        function getRandomSpeed() {
            const speeds = ['🚀 پرسرعت', '⚡ سریع', '📶 متوسط'];
            return speeds[Math.floor(Math.random() * speeds.length)];
        }

        function displayConfigs(configs) {
            const configsContainer = document.getElementById('configsContainer');
            configsContainer.innerHTML = '';
            
            configs.forEach((config, index) => {
                const configCard = document.createElement('div');
                configCard.className = 'bg-white rounded-xl shadow-md overflow-hidden config-card';
                configCard.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-bold text-base mb-1">${config.name}</h3>
                                <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                                    <span class="bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">${config.type}</span>
                                    <span>${config.speed}</span>
                                </div>
                                <p class="text-xs text-gray-500">منبع: ${config.source}</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2 mb-3">
                            <pre class="config-preview text-gray-600 overflow-hidden font-mono text-xs">${config.config.substring(0, 50)}...</pre>
                        </div>
                        <button data-config='${btoa(unescape(encodeURIComponent(JSON.stringify(config)))}' 
                                class="config-copy-btn bg-indigo-600 hover:bg-indigo-700 text-white w-full py-2 rounded-lg font-medium flex items-center justify-center transition-colors text-sm">
                            <svg class="icon icon-sm mr-2">
                                <use href="#copy-icon"/>
                            </svg>
                            کپی کانفیگ
                        </button>
                    </div>
                `;
                configsContainer.appendChild(configCard);
            });
            
            // Add event listeners to copy buttons
            document.querySelectorAll('.config-copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const encodedConfig = this.getAttribute('data-config');
                    showConfigDetails(encodedConfig);
                });
            });
        }

        function showConfigDetails(encodedConfig) {
            try {
                const configStr = decodeURIComponent(escape(atob(encodedConfig)));
                currentConfig = JSON.parse(configStr);
                
                const modal = document.getElementById('configModal');
                const configDetails = document.getElementById('configDetails');
                const modalTitle = document.getElementById('modalTitle');
                
                modalTitle.textContent = currentConfig.name;
                configDetails.textContent = currentConfig.config;
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Error showing config:', error);
                showToast('❌ خطا در نمایش کانفیگ', 'error');
            }
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.add('hidden');
        }

        function copyConfig() {
            if (currentConfig) {
                navigator.clipboard.writeText(currentConfig.config).then(() => {
                    showToast('✅ کانفیگ با موفقیت کپی شد', 'success');
                    closeConfigModal();
                }).catch(() => {
                    // روش جایگزین برای کپی
                    const textArea = document.createElement('textarea');
                    textArea.value = currentConfig.config;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('✅ کانفیگ با موفقیت کپی شد', 'success');
                    closeConfigModal();
                });
            }
        }

        // Exit functionality
        function showExitConfirm() {
            document.getElementById('exitModal').classList.remove('hidden');
        }

        function hideExitModal() {
            document.getElementById('exitModal').classList.add('hidden');
        }

        function exitApp() {
            showToast('👋 با تشکر از استفاده شما', 'info');
            setTimeout(() => {
                if (window.navigator && window.navigator.app) {
                    window.navigator.app.exitApp();
                } else if (window.close) {
                    window.close();
                } else {
                    window.location.href = 'about:blank';
                }
            }, 1000);
        }

        function showToast(message, type = 'info') {
            // حذف toast قبلی
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ایجاد toast جدید
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // حذف toast بعد از 3 ثانیه
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 DOM loaded, initializing Neghabat...');
            
            // Initialize app functionality
            initializeApp();
            
            // Show welcome message
            setTimeout(() => {
                showToast('🔑 برای شروع، یکی از منابع بالا را انتخاب کنید', 'info');
            }, 1000);

            console.log('🎉 Neghabat initialized successfully!');
        });
    </script>
</body>
</html>
